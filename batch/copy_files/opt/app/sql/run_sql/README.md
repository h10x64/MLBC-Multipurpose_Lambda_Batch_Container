# run_sql — SQL ファイルの一括実行

`run_sql.sh` は、`sql/` フォルダ内の SQL ファイルを環境変数 `DATABASE_URL` で指定した PostgreSQL に接続し、`psql` で順に実行します。  
`DATABASE_URL` が未設定の場合は実行せずに正常終了します。

---

## 必要な環境変数

| 変数 | 必須 | 説明 |
|------|------|------|
| `DATABASE_URL` | 〇（実行する場合） | PostgreSQL の接続文字列。未設定時は SQL 実行をスキップして終了します。 |

### DATABASE_URL の形式

```
postgresql://[ユーザ名]:[パスワード]@[ホスト]:[ポート]/[DB名]
```

- **ホスト**: RDS のエンドポイント、自前サーバのホスト名または IP アドレス
- **ポート**: 通常は `5432`
- パスワードに特殊文字が含まれる場合は URL エンコードしてください。

例（env ファイルに記載）:

```bash
DATABASE_URL=postgresql://myuser:mypass@mydb.xxxxx.ap-northeast-1.rds.amazonaws.com:5432/mydb
```

env ファイルは `copy_files/_env_/` の各環境用（01_local.env / 02_staging.env / 03_product.env）で設定します。

---

## SQL ファイルの配置と実行順

- 実行対象の SQL は **`run_sql/sql/`** に配置します。
- 現状は `run_sql.sh` 内でファイルを個別に指定して実行しています。
- 複数ファイルをまとめて実行する場合は、スクリプト内の `for` 文のコメントを外して `sql/*.sql` をループする形に変更できます。その場合、ファイル名の辞書順で実行されます。

---

## 外部ネットワーク（RDS 等）へ接続する場合の VPC・セキュリティグループ

Lambda や ECS などから VPC 内の RDS やオンプレの DB に接続する場合は、**Lambda を VPC に配置**し、**セキュリティグループ**で DB への通信を許可する必要があります。

### 1. Lambda を VPC に配置する

- Lambda の「設定」→「VPC」で、RDS が属する **VPC** と、DB に到達可能な **サブネット**（通常はプライベートサブネット）を選択します。
- 同一 VPC 内の RDS には、プライベートサブネットに配置した Lambda からそのまま接続できます。

### 2. セキュリティグループの設定

#### Lambda 用セキュリティグループ（Lambda にアタッチする SG）

| 方向 | タイプ | ポート | 送信元/送信先 | 説明 |
|------|--------|--------|----------------|------|
| アウトバウンド | カスタム TCP | 5432 | RDS 用 SG、または RDS の IP/サブネット | PostgreSQL へ接続するため |
| アウトバウンド | その他 | 必要に応じて | 0.0.0.0/0 など | VPC 外の AWS API（CloudWatch Logs 等）を使う場合は、NAT 経由でインターネットへ出るため。HTTPS(443) を開ける場合が多いです。 |

- RDS が同じ VPC 内にある場合は、**送信先に「RDS 用セキュリティグループ」を指定**すると、その SG を付けた RDS だけにアクセスできます。
- Lambda をプライベートサブネットに置く場合、CloudWatch Logs や ECR など AWS API を使うため、**NAT ゲートウェイ**経由でインターネットに出る必要があります。その場合は、アウトバウンドで HTTPS(443) を 0.0.0.0/0 に許可する設定が一般的です。

#### RDS（PostgreSQL）用セキュリティグループ

| 方向 | タイプ | ポート | 送信元 | 説明 |
|------|--------|--------|--------|------|
| インバウンド | PostgreSQL | 5432 | Lambda 用 SG | Lambda からの接続を許可する |

- **送信元**に、上記で作成した **Lambda 用セキュリティグループ** を指定します。  
  これにより、その SG を付けた Lambda のみが RDS の 5432 に接続できます。

### 3. まとめ（RDS 接続の流れ）

1. Lambda に「Lambda 用 SG」を付与し、VPC のプライベートサブネットに配置する。
2. Lambda 用 SG のアウトバウンドで、TCP 5432 を「RDS 用 SG」に向けて許可する。
3. RDS 用 SG のインバウンドで、TCP 5432 の送信元を「Lambda 用 SG」にする。
4. プライベートサブネットからインターネット（AWS API）へ出す必要がある場合は、NAT ゲートウェイを用意し、Lambda 用 SG のアウトバウンドで HTTPS(443) 等を許可する。

これで、Lambda から RDS への接続と、必要に応じた AWS API へのアクセスが可能になります。
